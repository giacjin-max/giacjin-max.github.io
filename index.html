<!doctype html>
<html lang="it"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Generatore Markdown (fallback)</title>
<style>
body{font-family:Arial;margin:20px;background:#f7f7f7}textarea{width:100%;height:120px;margin:6px 0;padding:8px}
button{padding:8px 12px;margin-right:6px}#out{white-space:pre-wrap;background:#fff;padding:12px;border:1px solid #ddd}
#preview{margin-top:12px;background:#fff;padding:12px;border:1px solid #ddd}
</style>
</head><body>
<h2>Generatore Markdown (robusto)</h2>
<p>Titoli (uno per riga)</p><textarea id="titles"></textarea>
<p>Link (uno per riga)</p><textarea id="links"></textarea>
<p><button id="gen">Genera</button><button id="copy">Copia</button></p>
<pre id="out"></pre>
<div id="preview"></div>

<!-- CDN pinyin (versione usata) -->
<script src="https://cdn.jsdelivr.net/npm/pinyin-pro/dist/pinyin-pro.min.js"></script>

<script>
function isChinese(s){ return /[\u4e00-\u9fff]/.test(s); }

document.getElementById('gen').onclick = () => {
  const ts = document.getElementById('titles').value.trim().split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
  const ls = document.getElementById('links').value.trim().split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
  if(ts.length !== ls.length){ alert("Titoli e link devono corrispondere"); return; }
  // build array
  const arr = ts.map((t,i)=>({t, l: ls[i]}));
  // try pinyinPro
  let hasPinyin = (typeof window.pinyinPro !== 'undefined');
  if(hasPinyin){
    arr.sort((a,b)=>{
      const ca = isChinese(a.t), cb = isChinese(b.t);
      if(ca && !cb) return -1;
      if(!ca && cb) return 1;
      const ka = ca ? window.pinyinPro.pinyin(a.t,{toneType:'none'}) : a.t;
      const kb = cb ? window.pinyinPro.pinyin(b.t,{toneType:'none'}) : b.t;
      return ka.localeCompare(kb);
    });
  } else {
    // fallback: simple localeCompare (no pinyin)
    arr.sort((a,b)=> a.t.localeCompare(b.t));
  }

  let markdown = '', current = '', n = 1;
  for(const it of arr){
    const letter = (isChinese(it.t) && hasPinyin) ? window.pinyinPro.pinyin(it.t,{toneType:'none'})[0].toUpperCase() : it.t[0].toUpperCase();
    if(letter !== current){ current = letter; markdown += `\n${letter}\n\n`; }
    markdown += `${n}. [${it.t}](${it.l})\n`;
    n++;
  }
  document.getElementById('out').textContent = markdown.trim();
  // preview simple
  const html = markdown.replace(/^(.+)$/gm, (m)=> {
    if(/^(\d+)\. /.test(m)) return `<div>${m.replace(/^(\d+)\.\s*(.+)$/, (_,i,t)=> `${i}. <a href="${(t.match(/\((.+)\)$/)||[])[1]||'#'}" target="_blank">${t.replace(/\s*\(.+$/,'')}</a>`)}</div>`;
    return `<h4>${m}</h4>`;
  });
  document.getElementById('preview').innerHTML = html;
};

document.getElementById('copy').onclick = () => {
  const t = document.getElementById('out').textContent;
  navigator.clipboard.writeText(t).then(()=> alert('Copiato'), ()=> alert('Errore copia'));
};
</script>
</body></html>
